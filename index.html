<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>Meu Controle de Gastos</title>

  <!-- PWA / App-like -->
  <meta name="theme-color" content="#4CAF50" />
  <meta name="mobile-web-app-capable" content="yes" />

  <!-- iOS (Safari) -->
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-title" content="Gastos" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

  <!-- √çcone inline (em iOS pode variar) -->
  <link rel="icon" type="image/svg+xml"
    href="data:image/svg+xml,%3Csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%20100%20100'%3E%3Crect%20width='100'%20height='100'%20rx='20'%20fill='%234CAF50'/%3E%3Ctext%20x='50'%20y='67'%20font-size='58'%20text-anchor='middle'%20fill='white'%3E%F0%9F%92%B0%3C/text%3E%3C/svg%3E" />

  <link rel="apple-touch-icon"
    href="data:image/svg+xml,%3Csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%20100%20100'%3E%3Crect%20width='100'%20height='100'%20rx='20'%20fill='%234CAF50'/%3E%3Ctext%20x='50'%20y='67'%20font-size='58'%20text-anchor='middle'%20fill='white'%3E%F0%9F%92%B0%3C/text%3E%3C/svg%3E" />

  <style>
    :root{
      --primary:#4CAF50;
      --dark:#2E7D32;
      --light:#E8F5E9;
      --card:#FFFFFF;
      --text:#222;
      --muted:#666;
      --border:#d9d9d9;
      --shadow: 0 1px 3px rgba(0,0,0,0.10);
      --danger:#d32f2f;
      --warn:#FF9800;
      --info:#2196F3;
      --bg: var(--light);
    }

    body.dark{
      --bg:#0f1411;
      --card:#151b17;
      --text:#f1f1f1;
      --muted:#b9b9b9;
      --border:#2a332d;
      --shadow: 0 1px 3px rgba(0,0,0,0.45);
    }

    *{ box-sizing:border-box; margin:0; padding:0; font-family: system-ui, -apple-system, sans-serif;}
    body{
      background: var(--bg);
      color: var(--text);
      padding: 16px;
      max-width: 720px;
      margin: 0 auto;
      font-size: 18px; /* mais confort√°vel */
      line-height: 1.35;
    }

    header{
      background: var(--primary);
      color:#fff;
      border-radius: 14px;
      padding: 14px 14px;
      box-shadow: var(--shadow);
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 12px;
    }
    header h1{ font-size: 1.35rem; }
    .top-actions{ display:flex; gap: 10px; align-items:center; }
    .chip{
      background: rgba(255,255,255,0.18);
      border: 1px solid rgba(255,255,255,0.25);
      color:#fff;
      padding: 8px 10px;
      border-radius: 999px;
      font-size: 0.95rem;
      cursor:pointer;
      user-select:none;
      white-space: nowrap;
    }

    .card{
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 14px;
      margin-top: 14px;
      box-shadow: var(--shadow);
    }

    .balance{
      text-align:center;
      font-weight: 800;
      color: var(--dark);
      font-size: 1.15rem;
    }
    body.dark .balance{ color: #a7ffb0; }

    .row{ display:flex; gap: 12px; flex-wrap: wrap; }
    .col{ flex:1; min-width: 220px; }

    label{ display:block; font-weight: 700; margin-bottom: 6px; }
    input, select, textarea{
      width:100%;
      padding: 12px;
      border: 1px solid var(--border);
      background: transparent;
      color: var(--text);
      border-radius: 12px;
      font-size: 1rem;
      outline: none;
    }
    textarea{ min-height: 86px; resize: vertical; }

    button{
      width: 100%;
      padding: 12px;
      border-radius: 12px;
      border: none;
      font-size: 1.05rem;
      cursor:pointer;
      background: var(--primary);
      color:#fff;
    }
    button:hover{ filter: brightness(0.95); }
    .btn-secondary{ background: #3b3b3b; }
    .btn-info{ background: var(--info); }
    .btn-warn{ background: var(--warn); color:#1f1f1f; font-weight: 800; }
    .btn-danger{ background: var(--danger); }
    .btn-ghost{
      background: transparent;
      border: 1px solid var(--border);
      color: var(--text);
      font-weight: 700;
    }

    .install-card{ display:none; }
    .install-row{ display:flex; gap: 12px; align-items:center; justify-content: space-between; }
    .install-row button{ width: auto; padding: 10px 14px; font-size: 1rem; }

    .medal{
      text-align:center;
      font-size: 1.05rem;
      color: #b8860b;
      margin-top: 8px;
      font-weight: 700;
    }

    .calendar{
      display:grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 6px;
      margin-top: 10px;
    }
    .cal-day{
      text-align:center;
      padding: 10px 6px;
      background: rgba(0,0,0,0.06);
      border-radius: 10px;
      font-size: 0.95rem;
      border: 1px solid transparent;
      cursor: pointer;
      user-select:none;
    }
    body.dark .cal-day{ background: rgba(255,255,255,0.08); }
    .cal-day.head{ background: transparent; border:none; cursor: default; font-weight:800; color: var(--muted); }
    .cal-day.has-data{ background: var(--primary); color:#fff; }
    .cal-day.today{ border-color: var(--dark); }
    body.dark .cal-day.today{ border-color: #a7ffb0; }
    .cal-day.selected{ outline: 3px solid rgba(33,150,243,0.45); }

    .small{
      color: var(--muted);
      font-size: 0.95rem;
    }

    .progress{
      height: 14px;
      background: rgba(0,0,0,0.08);
      border-radius: 999px;
      overflow:hidden;
      margin-top: 10px;
      border: 1px solid var(--border);
    }
    body.dark .progress{ background: rgba(255,255,255,0.10); }
    .progress > div{
      height: 100%;
      width: 0%;
      background: var(--primary);
      transition: width .25s ease;
    }

    .summary-table{
      width:100%;
      border-collapse: collapse;
      margin-top: 12px;
      overflow:hidden;
      border-radius: 14px;
      border: 1px solid var(--border);
    }
    .summary-table th, .summary-table td{
      padding: 12px 10px;
      border-bottom: 1px solid var(--border);
      text-align:left;
      font-size: 0.98rem;
    }
    .summary-table th{
      background: rgba(76,175,80,0.18);
      font-weight: 900;
    }
    .summary-table tr:last-child td{ border-bottom:none; }

    .detail-item{
      display:flex;
      gap: 10px;
      align-items:flex-start;
      justify-content: space-between;
      padding: 10px 0;
      border-bottom: 1px solid var(--border);
    }
    .detail-item:last-child{ border-bottom:none; }
    .detail-left{ min-width: 0; }
    .detail-main{
      font-weight: 800;
      margin-bottom: 2px;
    }
    .detail-note{
      color: var(--muted);
      font-size: 0.95rem;
      word-break: break-word;
    }
    .detail-actions{
      display:flex;
      gap: 8px;
      flex-shrink: 0;
    }
    .mini-btn{
      width: auto;
      padding: 10px 10px;
      border-radius: 10px;
      font-size: 0.95rem;
      font-weight: 800;
    }

    .modal-backdrop{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 16px;
      z-index: 999;
    }
    .modal{
      width: 100%;
      max-width: 520px;
      background: var(--card);
      color: var(--text);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 14px;
      box-shadow: var(--shadow);
    }
    .modal h3{ margin-bottom: 10px; }
    .modal .row{ margin-top: 10px; }
    .modal .modal-actions{ display:flex; gap: 10px; margin-top: 12px; }
    .modal .modal-actions button{ flex:1; }

    canvas{
      width: 100%;
      height: 230px;
      border: 1px solid var(--border);
      border-radius: 14px;
      background: rgba(0,0,0,0.02);
    }
    body.dark canvas{ background: rgba(255,255,255,0.04); }

    footer{
      margin-top: 18px;
      text-align:center;
      color: var(--muted);
      font-size: 0.9rem;
      padding-bottom: 10px;
    }
    footer a{ color: var(--primary); text-decoration:none; }
    footer a:hover{ text-decoration: underline; }
  </style>
</head>

<body>
  <header>
    <h1>üí∞ Meu Controle Di√°rio</h1>
    <div class="top-actions">
      <div class="chip" id="darkToggle">üåô Modo</div>
      <div class="chip" id="helpBtn">‚ùî Ajuda</div>
    </div>
  </header>

  <div class="card balance" id="balance">Balan√ßo de hoje: R$ 0,00</div>

  <!-- Card de instala√ß√£o (Android/Chrome) -->
  <div class="card install-card" id="installCard">
    <div class="install-row">
      <div>
        <div style="font-weight:900;">Instalar como app</div>
        <div class="small">Fica na tela inicial e abre sem barra do navegador.</div>
      </div>
      <button id="installBtn">Instalar</button>
    </div>
  </div>

  <!-- Mensagem inicial -->
  <div class="card" id="welcomeCard" style="display:none;">
    <div style="font-weight:900; font-size:1.05rem;">Bem-vindo! üëã</div>
    <div class="small" style="margin-top:6px;">
      Dica r√°pida: registre os gastos do dia e clique no calend√°rio para ver/editar o dia desejado.
    </div>
    <div style="margin-top:10px;">
      <button class="btn-ghost" id="closeWelcome">Entendi</button>
    </div>
  </div>

  <!-- Lan√ßamento -->
  <div class="card">
    <div class="row">
      <div class="col">
        <label for="date">Data do gasto</label>
        <input type="date" id="date">
        <div class="small" id="dateBR" style="margin-top:6px;"></div>
      </div>
      <div class="col">
        <label for="amount">Valor (R$)</label>
        <input type="number" id="amount" step="0.01" placeholder="0,00" min="0">
      </div>
    </div>

    <div class="row" style="margin-top:12px;">
      <div class="col">
        <label for="category">Categoria</label>
        <select id="category"></select>
      </div>
      <div class="col">
        <label for="note">Observa√ß√£o (opcional)</label>
        <input type="text" id="note" placeholder="Ex: almo√ßo com Sofia">
      </div>
    </div>

    <button style="margin-top:12px;" onclick="addExpense()">‚ûï Registrar gasto</button>
    <div class="medal" id="medal"></div>
  </div>

  <!-- Meta mensal + m√™s -->
  <div class="card">
    <div class="row">
      <div class="col">
        <div style="font-weight:900;">üìå Meta do m√™s</div>
        <div class="small">Defina um teto mensal para acompanhar o ritmo do gasto.</div>
      </div>
      <div class="col">
        <label for="monthlyGoal">Meta (R$)</label>
        <input type="number" id="monthlyGoal" step="1" min="0" placeholder="Ex: 2500">
        <button class="btn-ghost" style="margin-top:10px;" onclick="saveGoal()">Salvar meta</button>
      </div>
    </div>

    <div style="margin-top:12px; font-weight:900;" id="currentMonth">M√™s/Ano</div>
    <div class="small" id="monthlyStats">Total: R$ 0,00 | Dias com gastos: 0/0 | M√©dia/dia: R$ 0,00</div>
    <div class="progress"><div id="goalBar"></div></div>
    <div class="small" id="goalText" style="margin-top:8px;"></div>

    <div class="row" style="margin-top:12px;">
      <button class="btn-ghost" onclick="changeMonth(-1)">‚óÄ M√™s anterior</button>
      <button class="btn-ghost" onclick="changeMonth(1)">M√™s seguinte ‚ñ∂</button>
    </div>

    <div class="row" style="margin-top:12px;">
      <button class="btn-warn" onclick="rollMonth()">üóìÔ∏è Virar o m√™s (arquivar)</button>
    </div>
    <div class="small" style="margin-top:8px;">
      ‚ÄúVirar o m√™s‚Äù guarda o m√™s atual no hist√≥rico e limpa o m√™s em andamento (sem apagar meses antigos).
    </div>
  </div>

  <!-- Calend√°rio -->
  <div class="card">
    <div style="font-weight:900;">üìÖ Calend√°rio</div>
    <div class="small">Clique em um dia para ver, editar ou excluir gastos daquele dia.</div>
    <div class="calendar" id="calendar"></div>
  </div>

  <!-- Detalhe do dia selecionado -->
  <div class="card">
    <div style="font-weight:900;" id="selectedDayTitle">üßæ Detalhe do dia</div>
    <div class="small" id="selectedDaySubtitle">Selecione um dia no calend√°rio.</div>
    <div id="dayDetailList" style="margin-top:10px;"></div>
  </div>

  <!-- Tabela resumo -->
  <div class="card">
    <div style="font-weight:900;">üìã Resumo por dia (√∫ltimos lan√ßamentos)</div>
    <table class="summary-table">
      <thead>
        <tr>
          <th>Data</th>
          <th>Total</th>
        </tr>
      </thead>
      <tbody id="summaryBody"></tbody>
    </table>
  </div>

  <!-- Gr√°fico por categoria -->
  <div class="card">
    <div style="font-weight:900;">üìä Categorias do m√™s</div>
    <div class="small">Vis√£o simples: quanto foi em cada categoria no m√™s atual.</div>
    <canvas id="catChart" width="700" height="260"></canvas>
    <div class="small" id="chartHint" style="margin-top:10px;"></div>
  </div>

  <div class="card">
    <button class="btn-info" onclick="generatePDF()">üìÑ Gerar relat√≥rio PDF</button>
  </div>

  <footer>
    ¬© 2026 Ricardo de Faria Barros. Todos os direitos reservados.<br>
    Inspire-se na longelesc√™ncia:
    <a href="https://www.plenalongevidade.com.br" target="_blank" rel="noopener">www.plenalongevidade.com.br</a>
  </footer>

  <!-- Modal Editar -->
  <div class="modal-backdrop" id="editBackdrop" role="dialog" aria-modal="true">
    <div class="modal">
      <h3>‚úèÔ∏è Editar gasto</h3>
      <div class="small" id="editInfo"></div>

      <div class="row">
        <div class="col">
          <label for="editAmount">Valor (R$)</label>
          <input type="number" id="editAmount" step="0.01" min="0">
        </div>
        <div class="col">
          <label for="editCategory">Categoria</label>
          <select id="editCategory"></select>
        </div>
      </div>

      <div class="row">
        <div class="col">
          <label for="editNote">Observa√ß√£o</label>
          <input type="text" id="editNote" placeholder="Opcional">
        </div>
      </div>

      <div class="modal-actions">
        <button class="btn-ghost" onclick="closeEdit()">Cancelar</button>
        <button onclick="saveEdit()">Salvar</button>
      </div>
    </div>
  </div>

  <!-- Modal Ajuda -->
  <div class="modal-backdrop" id="helpBackdrop" role="dialog" aria-modal="true">
    <div class="modal">
      <h3>‚ùî Ajuda r√°pida</h3>
      <div class="small">
        ‚Ä¢ Registre um gasto e ele fica guardado no seu aparelho (localStorage).<br>
        ‚Ä¢ Clique em um dia no calend√°rio para ver os gastos daquele dia.<br>
        ‚Ä¢ No detalhe do dia voc√™ pode <strong>Editar</strong> ou <strong>Excluir</strong> um gasto.<br>
        ‚Ä¢ Meta mensal mostra sua barra de progresso no m√™s atual.<br>
        ‚Ä¢ No iPhone, instale pelo Safari: Compartilhar ‚Üí ‚ÄúAdicionar √† Tela de In√≠cio‚Äù.
      </div>
      <div class="modal-actions" style="margin-top:12px;">
        <button onclick="closeHelp()">Fechar</button>
      </div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script>
    // =========================
    // 1) Manifest embutido (arquivo √∫nico)
    // =========================
    (function injectManifest() {
      const manifest = {
        name: "Meu Controle de Gastos",
        short_name: "Gastos",
        description: "Controle simples e r√°pido de gastos di√°rios.",
        start_url: "./",
        scope: "./",
        display: "standalone",
        background_color: "#E8F5E9",
        theme_color: "#4CAF50",
        lang: "pt-BR",
        orientation: "portrait",
        icons: [
          {
            src: "data:image/svg+xml,%3Csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%20100%20100'%3E%3Crect%20width='100'%20height='100'%20rx='20'%20fill='%234CAF50'/%3E%3Ctext%20x='50'%20y='67'%20font-size='58'%20text-anchor='middle'%20fill='white'%3E%F0%9F%92%B0%3C/text%3E%3C/svg%3E",
            sizes: "512x512",
            type: "image/svg+xml",
            purpose: "any maskable"
          }
        ]
      };
      const json = JSON.stringify(manifest);
      const href = "data:application/manifest+json;charset=utf-8," + encodeURIComponent(json);

      let link = document.querySelector('link[rel="manifest"]');
      if (!link) {
        link = document.createElement("link");
        link.rel = "manifest";
        document.head.appendChild(link);
      }
      link.href = href;
    })();

    // =========================
    // 2) Service Worker embutido (Blob)
    // =========================
    (function registerInlineSW() {
      if (!("serviceWorker" in navigator)) return;
      const swCode = `
        const CACHE_NAME = "gastos-singlefile-v2";
        const CORE = ["./"];
        self.addEventListener("install", (event) => {
          event.waitUntil(caches.open(CACHE_NAME).then((cache) => cache.addAll(CORE)));
          self.skipWaiting();
        });
        self.addEventListener("activate", (event) => {
          event.waitUntil(
            caches.keys().then((keys) => Promise.all(keys.map((k) => (k !== CACHE_NAME ? caches.delete(k) : null))))
          );
          self.clients.claim();
        });
        self.addEventListener("fetch", (event) => {
          event.respondWith(caches.match(event.request).then((cached) => cached || fetch(event.request)));
        });
      `;
      const blob = new Blob([swCode], { type: "text/javascript" });
      const swUrl = URL.createObjectURL(blob);
      window.addEventListener("load", () => {
        navigator.serviceWorker.register(swUrl).catch(() => {});
      });
    })();

    // =========================
    // 3) Bot√£o "Instalar" (Android/Chrome)
    // =========================
    let deferredPrompt = null;
    const installCard = document.getElementById("installCard");
    const installBtn = document.getElementById("installBtn");

    window.addEventListener("beforeinstallprompt", (e) => {
      e.preventDefault();
      deferredPrompt = e;
      installCard.style.display = "block";
    });

    installBtn?.addEventListener("click", async () => {
      if (!deferredPrompt) return;
      deferredPrompt.prompt();
      try { await deferredPrompt.userChoice; } catch {}
      deferredPrompt = null;
      installCard.style.display = "none";
    });

    // =========================
    // Dados + categorias
    // =========================
    const CATEGORIES = [
      { id:"alimentacao", label:"üõí Alimenta√ß√£o" },
      { id:"feira", label:"üß∫ Feira" },
      { id:"padaria", label:"ü•ê Padaria" },
      { id:"bares", label:"üç∑ Bares/Restaurantes" },
      { id:"farmacia", label:"üíä Farm√°cia" },
      { id:"gasolina", label:"‚õΩ Gasolina" },
      { id:"uber", label:"üöï Uber/Transporte" },
      { id:"agua", label:"üíß √Ågua" },
      { id:"energia", label:"‚ö° Energia" },
      { id:"telefone", label:"üì± Telefone/Internet" },
      { id:"condominio", label:"üè¢ Condom√≠nio" },
      { id:"diarista", label:"üßπ Diarista" },
      { id:"impostos", label:"üèõÔ∏è Impostos" },
      { id:"prestacoes", label:"üè† Presta√ß√µes" },
      { id:"manutencao", label:"üîß Manuten√ß√£o" },
      { id:"lazer", label:"üé≠ Lazer" },
      { id:"contas", label:"üìÑ Contas Fixas" },
      { id:"aluguel", label:"üè† Aluguel" },
      { id:"cartao", label:"üí≥ Fatura Cart√£o" },
      { id:"dizimo", label:"‚ù§Ô∏è D√≠zimo/Doa√ß√£o" },
      { id:"online", label:"üì¶ Compras Online" },
      { id:"diversos", label:"‚ú® Diversos" }
    ];

    function fillCategorySelect(selectEl) {
      selectEl.innerHTML = "";
      for (const c of CATEGORIES) {
        const opt = document.createElement("option");
        opt.value = c.id;
        opt.textContent = c.label;
        selectEl.appendChild(opt);
      }
    }
    fillCategorySelect(document.getElementById("category"));
    fillCategorySelect(document.getElementById("editCategory"));

    // =========================
    // Utilit√°rios de data/moeda
    // =========================
    function formatDateISO(date = new Date()) {
      return date.toISOString().split("T")[0];
    }
    function formatBR(dateStr) {
      const [y,m,d] = dateStr.split("-");
      return `${d}/${m}/${y}`;
    }
    function parseISO(dateStr){
      const [y,m,d] = dateStr.split("-").map(n=>parseInt(n,10));
      return new Date(y, m-1, d);
    }
    function monthKey(year, monthIndex){
      return `${year}-${String(monthIndex+1).padStart(2,"0")}`;
    }
    function formatCurrency(v){
      return new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(v);
    }
    function safeNumber(n){ return (typeof n === "number" && isFinite(n)) ? n : 0; }

    // =========================
    // Estado (armazenamento)
    // =========================
    // expenses: { "YYYY-MM-DD": [ {amount,category,note,id} ] }
    let expenses = JSON.parse(localStorage.getItem("expenses") || "{}");
    let archives = JSON.parse(localStorage.getItem("archives") || "{}"); // { "YYYY-MM": {expenses:{}, goal:number} }
    let monthlyGoal = parseFloat(localStorage.getItem("monthlyGoal") || "0") || 0;

    let currentMonth = new Date().getMonth();
    let currentYear = new Date().getFullYear();
    const todayISO = formatDateISO(new Date());
    let selectedDay = todayISO;

    // =========================
    // Prefer√™ncias (modo escuro)
    // =========================
    const darkStored = localStorage.getItem("pref_dark");
    const prefersDark = window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches;
    const darkOn = (darkStored === null) ? prefersDark : (darkStored === "1");
    if (darkOn) document.body.classList.add("dark");

    document.getElementById("darkToggle").addEventListener("click", () => {
      document.body.classList.toggle("dark");
      localStorage.setItem("pref_dark", document.body.classList.contains("dark") ? "1" : "0");
      drawCategoryChart();
    });

    // =========================
    // Ajuda + boas-vindas
    // =========================
    const helpBackdrop = document.getElementById("helpBackdrop");
    document.getElementById("helpBtn").addEventListener("click", () => helpBackdrop.style.display = "flex");
    function closeHelp(){ helpBackdrop.style.display = "none"; }
    window.closeHelp = closeHelp;

    const welcomeCard = document.getElementById("welcomeCard");
    const firstRun = localStorage.getItem("firstRunDone") !== "1";
    if (firstRun) {
      welcomeCard.style.display = "block";
      localStorage.setItem("firstRunDone", "1");
    }
    document.getElementById("closeWelcome").addEventListener("click", () => welcomeCard.style.display = "none");

    // =========================
    // Inputs iniciais
    // =========================
    const dateInput = document.getElementById("date");
    dateInput.value = todayISO;
    setDateBRHint(todayISO);

    dateInput.addEventListener("change", () => {
      setDateBRHint(dateInput.value);
    });

    function setDateBRHint(iso){
      document.getElementById("dateBR").textContent = iso ? `Formato: ${formatBR(iso)}` : "";
    }

    document.getElementById("monthlyGoal").value = monthlyGoal ? String(monthlyGoal) : "";

    function saveGoal(){
      const val = parseFloat(document.getElementById("monthlyGoal").value);
      monthlyGoal = (isNaN(val) || val < 0) ? 0 : val;
      localStorage.setItem("monthlyGoal", String(monthlyGoal));
      renderAll();
    }
    window.saveGoal = saveGoal;

    // =========================
    // CRUD de gastos
    // =========================
    function uuid(){
      return Math.random().toString(16).slice(2) + "-" + Date.now().toString(16);
    }

    function save(){
      localStorage.setItem("expenses", JSON.stringify(expenses));
      localStorage.setItem("archives", JSON.stringify(archives));
      renderAll();
    }

    function addExpense(){
      const iso = dateInput.value;
      const amount = parseFloat(document.getElementById("amount").value);
      const category = document.getElementById("category").value;
      const note = (document.getElementById("note").value || "").trim();

      if (!iso) { alert("Selecione uma data."); return; }
      if (isNaN(amount) || amount <= 0) { alert("Digite um valor v√°lido."); return; }

      if (!expenses[iso]) expenses[iso] = [];
      expenses[iso].push({ id: uuid(), amount, category, note });

      document.getElementById("amount").value = "";
      document.getElementById("note").value = "";

      // ap√≥s registrar, seleciona o dia para facilitar edi√ß√£o
      selectedDay = iso;
      // garante que estamos olhando o m√™s do gasto
      const d = parseISO(iso);
      currentYear = d.getFullYear();
      currentMonth = d.getMonth();

      save();
    }
    window.addExpense = addExpense;

    function deleteExpense(dayISO, itemId){
      const list = expenses[dayISO] || [];
      const idx = list.findIndex(x => x.id === itemId);
      if (idx < 0) return;
      if (!confirm("Excluir este gasto?")) return;
      list.splice(idx,1);
      if (list.length === 0) delete expenses[dayISO];
      save();
    }
    window.deleteExpense = deleteExpense;

    // Modal edi√ß√£o
    const editBackdrop = document.getElementById("editBackdrop");
    const editInfo = document.getElementById("editInfo");
    const editAmount = document.getElementById("editAmount");
    const editCategory = document.getElementById("editCategory");
    const editNote = document.getElementById("editNote");

    let editing = { dayISO:null, id:null };

    function openEdit(dayISO, itemId){
      const item = (expenses[dayISO] || []).find(x => x.id === itemId);
      if (!item) return;

      editing = { dayISO, id: itemId };
      editInfo.textContent = `Data: ${formatBR(dayISO)}`;

      editAmount.value = String(item.amount ?? "");
      editCategory.value = item.category ?? "diversos";
      editNote.value = item.note ?? "";

      editBackdrop.style.display = "flex";
    }
    window.openEdit = openEdit;

    function closeEdit(){
      editBackdrop.style.display = "none";
      editing = { dayISO:null, id:null };
    }
    window.closeEdit = closeEdit;

    function saveEdit(){
      const { dayISO, id } = editing;
      if (!dayISO || !id) return;

      const item = (expenses[dayISO] || []).find(x => x.id === id);
      if (!item) return;

      const amount = parseFloat(editAmount.value);
      if (isNaN(amount) || amount <= 0) { alert("Digite um valor v√°lido."); return; }

      item.amount = amount;
      item.category = editCategory.value;
      item.note = (editNote.value || "").trim();

      closeEdit();
      save();
    }
    window.saveEdit = saveEdit;

    // =========================
    // Medalha 2 dias sem gastos
    // =========================
    function checkMedal(){
      const t = new Date();
      const y = new Date(); y.setDate(t.getDate()-1);
      const today = formatDateISO(t);
      const yest = formatDateISO(y);

      const noToday = !expenses[today] || expenses[today].length === 0;
      const noYest = !expenses[yest] || expenses[yest].length === 0;

      document.getElementById("medal").textContent = (noToday && noYest)
        ? "üèÜ Parab√©ns! 2 dias sem gastos!"
        : "";
    }

    // =========================
    // Calend√°rio + sele√ß√£o de dia
    // =========================
    function renderCalendar(){
      const cal = document.getElementById("calendar");
      const year = currentYear;
      const month = currentMonth;

      const first = new Date(year, month, 1);
      const last = new Date(year, month+1, 0);
      const startDay = first.getDay(); // 0=Dom
      const daysInMonth = last.getDate();

      let html = "";
      const wd = ["Dom","Seg","Ter","Qua","Qui","Sex","S√°b"];
      for (const d of wd) html += `<div class="cal-day head">${d}</div>`;

      for (let i=0;i<startDay;i++) html += `<div class="cal-day head"></div>`;

      for (let day=1; day<=daysInMonth; day++){
        const iso = `${year}-${String(month+1).padStart(2,"0")}-${String(day).padStart(2,"0")}`;
        const hasData = expenses[iso] && expenses[iso].length > 0;
        const isToday = iso === todayISO;
        const isSel = iso === selectedDay;

        let cls = "cal-day";
        if (hasData) cls += " has-data";
        if (isToday) cls += " today";
        if (isSel) cls += " selected";

        html += `<div class="${cls}" onclick="selectDay('${iso}')">${day}</div>`;
      }

      cal.innerHTML = html;
    }

    function selectDay(iso){
      selectedDay = iso;
      // se o usu√°rio clica um dia fora do m√™s vis√≠vel (raro), ajusta m√™s
      const d = parseISO(iso);
      currentYear = d.getFullYear();
      currentMonth = d.getMonth();
      renderAll();
    }
    window.selectDay = selectDay;

    // =========================
    // Resumo di√°rio e detalhe
    // =========================
    function dayTotal(iso){
      const list = expenses[iso] || [];
      return list.reduce((s,e) => s + safeNumber(e.amount), 0);
    }

    function renderSummaryTable(){
      const tbody = document.getElementById("summaryBody");

      const dates = Object.keys(expenses)
        .filter(d => (expenses[d] || []).length > 0)
        .sort((a,b) => new Date(b) - new Date(a))
        .slice(0, 20); // √∫ltimos 20 dias com gastos

      if (dates.length === 0){
        tbody.innerHTML = `<tr><td colspan="2" class="small" style="text-align:center;">Nenhum gasto registrado</td></tr>`;
        return;
      }

      let html = "";
      for (const d of dates){
        html += `
          <tr>
            <td>${formatBR(d)}</td>
            <td>${formatCurrency(dayTotal(d))}</td>
          </tr>
        `;
      }
      tbody.innerHTML = html;
    }

    function renderDayDetail(){
      const title = document.getElementById("selectedDayTitle");
      const sub = document.getElementById("selectedDaySubtitle");
      const listEl = document.getElementById("dayDetailList");

      if (!selectedDay){
        title.textContent = "üßæ Detalhe do dia";
        sub.textContent = "Selecione um dia no calend√°rio.";
        listEl.innerHTML = "";
        return;
      }

      title.textContent = `üßæ Detalhe do dia: ${formatBR(selectedDay)}`;
      const items = expenses[selectedDay] || [];
      const total = items.reduce((s,e)=> s + safeNumber(e.amount), 0);

      sub.textContent = items.length
        ? `Total do dia: ${formatCurrency(total)} ‚Ä¢ Itens: ${items.length}`
        : "Sem gastos neste dia.";

      if (!items.length){
        listEl.innerHTML = "";
        return;
      }

      const catMap = Object.fromEntries(CATEGORIES.map(c => [c.id, c.label]));
      let html = "";
      items.forEach((it) => {
        const catLabel = catMap[it.category] || it.category;
        html += `
          <div class="detail-item">
            <div class="detail-left">
              <div class="detail-main">${catLabel} ‚Ä¢ ${formatCurrency(safeNumber(it.amount))}</div>
              ${it.note ? `<div class="detail-note">${escapeHTML(it.note)}</div>` : `<div class="detail-note">‚Äî</div>`}
            </div>
            <div class="detail-actions">
              <button class="mini-btn btn-ghost" onclick="openEdit('${selectedDay}','${it.id}')">Editar</button>
              <button class="mini-btn btn-danger" onclick="deleteExpense('${selectedDay}','${it.id}')">Excluir</button>
            </div>
          </div>
        `;
      });
      listEl.innerHTML = html;
    }

    function escapeHTML(str){
      return String(str)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    // =========================
    // Resumo mensal + meta + m√™s
    // =========================
    function getMonthDates(year, month){
      const start = new Date(year, month, 1);
      const end = new Date(year, month+1, 0);
      const out = [];
      for (let d = new Date(start); d <= end; d.setDate(d.getDate()+1)){
        out.push(formatDateISO(new Date(d)));
      }
      return out;
    }

    function monthTotals(year, month){
      const dates = getMonthDates(year, month);
      const daysInMonth = dates.length;
      const daysWith = dates.filter(d => expenses[d] && expenses[d].length > 0);
      const total = daysWith.reduce((sum, d) => sum + dayTotal(d), 0);
      return { total, daysInMonth, daysWithCount: daysWith.length, dates };
    }

    function renderMonthlySummary(){
      const monthLabel = new Date(currentYear, currentMonth, 1)
        .toLocaleDateString("pt-BR", { month:"long", year:"numeric" });

      const { total, daysInMonth, daysWithCount } = monthTotals(currentYear, currentMonth);
      const avg = daysInMonth ? total / daysInMonth : 0;

      document.getElementById("currentMonth").textContent = monthLabel;
      document.getElementById("monthlyStats").textContent =
        `Total: ${formatCurrency(total)} | Dias com gastos: ${daysWithCount}/${daysInMonth} | M√©dia/dia: ${formatCurrency(avg)}`;

      // barra meta
      const bar = document.getElementById("goalBar");
      const goalText = document.getElementById("goalText");
      if (monthlyGoal > 0){
        const pct = Math.min(100, Math.round((total / monthlyGoal) * 100));
        bar.style.width = pct + "%";
        const rest = monthlyGoal - total;
        goalText.textContent = rest >= 0
          ? `Meta: ${formatCurrency(monthlyGoal)} ‚Ä¢ Falta: ${formatCurrency(rest)} (${pct}%)`
          : `Meta: ${formatCurrency(monthlyGoal)} ‚Ä¢ Estourou: ${formatCurrency(Math.abs(rest))} (${pct}%)`;
      } else {
        bar.style.width = "0%";
        goalText.textContent = "Defina uma meta para ver a barra de progresso.";
      }
    }

    function changeMonth(delta){
      currentMonth += delta;
      if (currentMonth < 0) { currentMonth = 11; currentYear--; }
      if (currentMonth > 11) { currentMonth = 0; currentYear++; }

      // ajusta selectedDay para um dia do m√™s atual (mant√©m o dia se poss√≠vel)
      const d = parseISO(selectedDay || todayISO);
      const day = Math.min(d.getDate(), new Date(currentYear, currentMonth+1, 0).getDate());
      selectedDay = `${currentYear}-${String(currentMonth+1).padStart(2,"0")}-${String(day).padStart(2,"0")}`;

      renderAll();
    }
    window.changeMonth = changeMonth;

    // =========================
    // Virar o m√™s (arquivar)
    // =========================
    function rollMonth(){
      const key = monthKey(currentYear, currentMonth);
      const monthDates = getMonthDates(currentYear, currentMonth);
      const monthExpenses = {};

      monthDates.forEach(d => {
        if (expenses[d] && expenses[d].length) monthExpenses[d] = expenses[d];
      });

      if (Object.keys(monthExpenses).length === 0){
        alert("Este m√™s n√£o tem gastos para arquivar.");
        return;
      }

      if (!confirm(`Arquivar o m√™s ${key} e limpar os gastos deste m√™s?`)) return;

      archives[key] = { expenses: monthExpenses, goal: monthlyGoal, archivedAt: Date.now() };

      // remove do m√™s atual
      monthDates.forEach(d => {
        if (expenses[d]) delete expenses[d];
      });

      save();
      alert("M√™s arquivado com sucesso!");
    }
    window.rollMonth = rollMonth;

    // =========================
    // Gr√°fico por categoria (m√™s atual)
    // =========================
    function categoryTotalsThisMonth(){
      const { dates } = monthTotals(currentYear, currentMonth);
      const totals = {};
      for (const c of CATEGORIES) totals[c.id] = 0;

      for (const d of dates){
        const list = expenses[d] || [];
        for (const it of list){
          if (!totals.hasOwnProperty(it.category)) totals[it.category] = 0;
          totals[it.category] += safeNumber(it.amount);
        }
      }
      return totals;
    }

    function drawCategoryChart(){
      const canvas = document.getElementById("catChart");
      const ctx = canvas.getContext("2d");

      // limpa
      ctx.clearRect(0,0,canvas.width,canvas.height);

      const totals = categoryTotalsThisMonth();
      const entries = Object.entries(totals)
        .filter(([,v]) => v > 0)
        .sort((a,b) => b[1]-a[1])
        .slice(0, 8); // top 8 para ficar leg√≠vel

      const hint = document.getElementById("chartHint");
      if (entries.length === 0){
        hint.textContent = "Sem dados no m√™s atual para montar o gr√°fico.";
        return;
      }

      hint.textContent = "Mostrando as 8 categorias com maior gasto (m√™s atual).";

      const w = canvas.width, h = canvas.height;
      const padding = 20;
      const barH = 22;
      const gap = 10;
      const maxVal = Math.max(...entries.map(e => e[1])) || 1;

      // cores neutras (sem definir paleta sofisticada, mas vis√≠vel em ambos os modos)
      const barColor = getComputedStyle(document.body).getPropertyValue("--primary").trim() || "#4CAF50";
      const textColor = getComputedStyle(document.body).getPropertyValue("--text").trim() || "#222";
      const muted = getComputedStyle(document.body).getPropertyValue("--muted").trim() || "#666";

      ctx.fillStyle = muted;
      ctx.font = "16px system-ui";

      const catMap = Object.fromEntries(CATEGORIES.map(c => [c.id, c.label]));
      let y = padding;

      entries.forEach(([cat, val], idx) => {
        const label = (catMap[cat] || cat).replace(/^.+?\s/, ""); // tira emoji no label longo do eixo
        const barW = Math.round(((w - padding*2 - 220) * (val / maxVal))); // espa√ßo para texto

        // label
        ctx.fillStyle = textColor;
        ctx.font = "16px system-ui";
        ctx.fillText(label, padding, y + 16);

        // valor
        ctx.fillStyle = muted;
        ctx.font = "14px system-ui";
        ctx.fillText(formatCurrency(val), w - padding - 140, y + 16);

        // barra
        ctx.fillStyle = barColor;
        ctx.fillRect(w - padding - 130, y, Math.max(4, barW), barH);

        y += barH + gap;
      });
    }

    // =========================
    // PDF
    // =========================
    async function generatePDF(){
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();

      doc.setFontSize(18);
      doc.text("Relat√≥rio de Gastos", 14, 18);

      const monthLabel = new Date(currentYear, currentMonth, 1).toLocaleDateString("pt-BR",{month:"long",year:"numeric"});
      doc.setFontSize(12);
      doc.text(`M√™s: ${monthLabel}`, 14, 26);

      const sortedDates = Object.keys(expenses)
        .filter(d => (expenses[d]||[]).length > 0)
        .sort((a,b) => new Date(a) - new Date(b));

      let y = 34;

      if (!sortedDates.length){
        doc.text("Nenhum gasto registrado.", 14, y);
        doc.save("meu-controle-gastos.pdf");
        return;
      }

      const catMap = Object.fromEntries(CATEGORIES.map(c => [c.id, c.label]));

      for (const date of sortedDates){
        const total = dayTotal(date);
        doc.setFontSize(12);
        doc.text(`${formatBR(date)}  ‚Äî  Total: ${formatCurrency(total)}`, 14, y);
        y += 7;

        for (const it of (expenses[date] || [])){
          const catLabel = catMap[it.category] || it.category;
          let line = `- ${catLabel}: ${formatCurrency(safeNumber(it.amount))}`;
          if (it.note) line += ` (${it.note})`;

          if (y > 280){ doc.addPage(); y = 18; }
          doc.setFontSize(10);
          doc.text(line, 16, y);
          y += 6;
        }

        y += 4;
        if (y > 280){ doc.addPage(); y = 18; }
      }

      doc.save("meu-controle-gastos.pdf");
    }
    window.generatePDF = generatePDF;

    // =========================
    // Render geral
    // =========================
    function getTodayTotal(){
      return dayTotal(todayISO);
    }

    function renderBalance(){
      document.getElementById("balance").textContent =
        `Balan√ßo de hoje (${formatBR(todayISO)}): ${formatCurrency(getTodayTotal())}`;
    }

    function renderAll(){
      renderBalance();
      checkMedal();
      renderMonthlySummary();
      renderCalendar();
      renderSummaryTable();
      renderDayDetail();
      drawCategoryChart();
    }

    // =========================
    // Inicializa√ß√£o
    // =========================
    // come√ßa selecionando hoje (facilita)
    selectedDay = todayISO;
    renderAll();

    // fechar modais clicando fora (opcional)
    helpBackdrop.addEventListener("click", (e) => { if (e.target === helpBackdrop) closeHelp(); });
    editBackdrop.addEventListener("click", (e) => { if (e.target === editBackdrop) closeEdit(); });
  </script>
</body>
</html>
